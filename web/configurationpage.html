<div id="oidcConfigPage" data-role="page" class="page type-interior pluginConfigurationPage" data-require="emby-input,emby-button,emby-select,emby-checkbox">
    <div class="content-primary">
        <form id="oidcConfigForm">
            <div class="verticalSection">
                <h2>OpenID Connect (OIDC) Configuration</h2>
                <p>Configure Single Sign-On settings for Jellyfin authentication.</p>
            </div>

            <div class="verticalSection">
                <div class="sectionTitleContainer">
                    <h2 class="sectionTitle">Basic Settings</h2>
                </div>

                <div class="inputContainer">
                    <label class="inputLabel inputLabelUnfocused" for="txtOidEndpoint">OIDC Authority</label>
                    <input is="emby-input" type="text" id="txtOidEndpoint" name="oidEndpoint" label="OIDC Authority" />
                    <div class="fieldDescription">The base URL of your OIDC provider (e.g., https://auth.example.com)</div>
                </div>

                <div class="inputContainer">
                    <label class="inputLabel inputLabelUnfocused" for="txtOidClientId">Client ID</label>
                    <input is="emby-input" type="text" id="txtOidClientId" name="oidClientId" label="Client ID" />
                    <div class="fieldDescription">The OIDC application client ID</div>
                </div>

                <div class="inputContainer">
                    <label class="inputLabel inputLabelUnfocused" for="txtOidSecret">Client Secret</label>
                    <input is="emby-input" type="password" id="txtOidSecret" name="oidSecret" label="Client Secret" />
                    <div class="fieldDescription">The OIDC application client secret</div>
                </div>
            </div>

            <div class="verticalSection">
                <div class="sectionTitleContainer">
                    <h2 class="sectionTitle">Scopes & Claims</h2>
                </div>

                <div class="inputContainer">
                    <label class="inputLabel inputLabelUnfocused" for="txtOidScopes">OAuth Scopes (one per line)</label>
                    <textarea is="emby-input" id="txtOidScopes" name="oidScopes" rows="4"></textarea>
                    <div class="fieldDescription">Default: openid, profile, email, groups</div>
                </div>

                <div class="inputContainer">
                    <label class="inputLabel inputLabelUnfocused" for="txtRoleClaim">Role Claim Name</label>
                    <input is="emby-input" type="text" id="txtRoleClaim" name="roleClaim" label="Role Claim" />
                    <div class="fieldDescription">The OIDC claim containing user roles/groups (e.g., 'groups')</div>
                </div>
            </div>

            <div>
                <button is="emby-button" type="submit" class="raised button-submit block">
                    <span>Save</span>
                </button>
            </div>
        </form>
    </div>

    <script type="text/javascript">
        (function () {
            const pluginId = '7f8b8d9e-1234-5678-90ab-cdef12345678';
            const page = document.querySelector('#oidcConfigPage');

            page.addEventListener('pageshow', function () {
                Dashboard.showLoadingMsg();
                ApiClient.getPluginConfiguration(pluginId).then(function (config) {
                    document.getElementById('txtOidEndpoint').value = config.OidEndpoint || '';
                    document.getElementById('txtOidClientId').value = config.OidClientId || '';
                    document.getElementById('txtOidSecret').value = config.OidSecret || '';
                    document.getElementById('txtRoleClaim').value = config.RoleClaim || 'groups';
                    
                    if (config.OidScopes && Array.isArray(config.OidScopes)) {
                        document.getElementById('txtOidScopes').value = config.OidScopes.join('\n');
                    }
                    
                    Dashboard.hideLoadingMsg();
                });
            });

            document.getElementById('oidcConfigForm').addEventListener('submit', function (e) {
                e.preventDefault();
                Dashboard.showLoadingMsg();

                const scopes = document.getElementById('txtOidScopes').value
                    .split('\n')
                    .map(s => s.trim())
                    .filter(s => s.length > 0);

                const config = {
                    OidEndpoint: document.getElementById('txtOidEndpoint').value,
                    OidClientId: document.getElementById('txtOidClientId').value,
                    OidSecret: document.getElementById('txtOidSecret').value,
                    OidScopes: scopes.length > 0 ? scopes : ['openid', 'profile', 'email', 'groups'],
                    RoleClaim: document.getElementById('txtRoleClaim').value || 'groups'
                };

                ApiClient.updatePluginConfiguration(pluginId, config).then(function () {
                    Dashboard.hideLoadingMsg();
                    Dashboard.processPluginConfigurationUpdateResult();
                });
            });
        })();
    </script>
</div>
